// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
//© GreenDayTrade

// a = Define lookback period to be a range of beteen 16 - 50 bars
//  a2 = Define correction between the divergence in price
//     a3 = treack high closing price and MACD value
//         a4 = define divergence
//             a5 = execute
//             simplified

//      If a
//          then a2
//              then a3

//////////////////////////////////////////
//@version=5
indicator("MACD Divergence Detector", shorttitle="MACD Div", overlay=true)

// Input for MACD
fastLength = input.int(12, minval=1, title="Fast Length")
slowLength = input.int(26, minval=1, title="Slow Length")
signalSmoothing = input.int(9, minval=1, title="Signal Smoothing")

[macdLine, signalLine, _] = ta.macd(close, fastLength, slowLength, signalSmoothing)

// Inputs for lookback range
minLookback = input(16, title="Minimum Lookback Period")
maxLookback = input(50, title="Maximum Lookback Period")

// Function to find peaks and troughs within the range
isHigh = ta.highestbars(high, maxLookback) == 0 and ta.highestbars(high, minLookback) >= 0
isLow = ta.lowestbars(low, maxLookback) == 0 and ta.lowestbars(low, minLookback) >= 0

var float lastHighPrice = na
var float lastHighMacd = na
var float lastLowPrice = na
var float lastLowMacd = na

var float currentHighPrice = na
var float currentHighMacd = na
var float currentLowPrice = na
var float currentLowMacd = na

if isHigh
    currentHighPrice := high
    currentHighMacd := macdLine
    if not na(lastHighPrice) and not na(lastHighMacd)
        if currentHighPrice > lastHighPrice and currentHighMacd < lastHighMacd
            lastHighPrice := currentHighPrice
            lastHighMacd := currentHighMacd

if isLow
    currentLowPrice := low
    currentLowMacd := macdLine
    if not na(lastLowPrice) and not na(lastLowMacd)
        if currentLowPrice < lastLowPrice and currentLowMacd > lastLowMacd
            lastLowPrice := currentLowPrice
            lastLowMacd := currentLowMacd

// Plot bullish divergence
plotshape(series=isHigh, title="Short Signal", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)

// Plot bearish divergence
plotshape(series=isLow, title="Long Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)

// Updating last high/low and MACD values
if isHigh
    lastHighPrice := high
    lastHighMacd := macdLine
else if isLow
    lastLowPrice := low
    lastLowMacd := macdLine

plot(macdLine, title="MACD Line", color=color.blue)
plot(signalLine, title="Signal Line", color=color.orange)